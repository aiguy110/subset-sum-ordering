<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subset Sum Ordering Visualizer</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/tomorrow-night-eighties.min.css">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #1a1a2e;
      color: #d0d0d0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    header {
      padding: 10px 20px;
      background: #16213e;
      border-bottom: 1px solid #0f3460;
      font-size: 0.95rem;
      font-weight: 600;
      color: #a8d8ff;
      flex-shrink: 0;
    }

    .workspace {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ── Editor pane ── */
    .pane-editor {
      width: 44%;
      min-width: 280px;
      border-right: 1px solid #0f3460;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .pane-label {
      padding: 6px 14px;
      background: #16213e;
      border-bottom: 1px solid #0f3460;
      font-family: monospace;
      font-size: 0.78rem;
      color: #607090;
      flex-shrink: 0;
    }

    /* ── Saved versions toolbar ── */
    .versions-bar {
      padding: 5px 10px;
      background: #131e30;
      border-bottom: 1px solid #0f3460;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
      flex-wrap: wrap;
    }

    .versions-bar select {
      flex: 1;
      min-width: 0;
      background: #111828;
      border: 1px solid #1e3a5f;
      color: #d0d0d0;
      padding: 3px 7px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-family: monospace;
      outline: none;
      cursor: pointer;
    }

    .versions-bar select:focus { border-color: #4a90d9; }

    .ver-btn {
      background: #1e3a5f;
      color: #a8d8ff;
      border: 1px solid #2a5080;
      padding: 3px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.78rem;
      white-space: nowrap;
      transition: background 0.15s;
    }

    .ver-btn:hover { background: #2a5080; }
    .ver-btn.danger { border-color: #5a2020; color: #e74c3c; }
    .ver-btn.danger:hover { background: #3a1010; }

    #editor-mount {
      flex: 1;
      overflow: hidden;
    }

    .CodeMirror {
      height: 100% !important;
      font-size: 13px;
      line-height: 1.5;
    }

    /* ── Output pane ── */
    .pane-output {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .controls {
      padding: 8px 14px;
      display: flex;
      gap: 8px;
      align-items: center;
      background: #16213e;
      border-bottom: 1px solid #0f3460;
      flex-shrink: 0;
    }

    .controls label {
      font-size: 0.82rem;
      color: #607090;
      white-space: nowrap;
    }

    #nums {
      flex: 1;
      background: #111828;
      border: 1px solid #1e3a5f;
      color: #d0d0d0;
      padding: 5px 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.9rem;
      outline: none;
    }

    #nums:focus { border-color: #4a90d9; }

    #run-btn {
      background: #1e3a5f;
      color: #a8d8ff;
      border: 1px solid #2a5080;
      padding: 5px 18px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.88rem;
      white-space: nowrap;
      transition: background 0.15s;
    }

    #run-btn:hover:not(:disabled) { background: #2a5080; }
    #run-btn:disabled { opacity: 0.45; cursor: default; }

    #output-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 14px 16px;
    }

    /* ── Partition display ── */
    .partition-row {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      align-items: flex-end;
      margin-bottom: 12px;
    }

    .group-block { text-align: center; }

    .group-chip {
      display: inline-block;
      padding: 3px 9px;
      border-radius: 10px;
      font-family: monospace;
      font-size: 0.82rem;
      font-weight: 700;
      color: #111;
    }

    .radix-label {
      display: block;
      font-size: 0.68rem;
      color: #556;
      text-align: center;
      margin-top: 2px;
    }

    .group-sep {
      color: #334;
      font-size: 1.1rem;
      padding-bottom: 14px;
      align-self: flex-end;
    }

    /* ── Summary banner ── */
    .summary {
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 0.85rem;
      margin-bottom: 14px;
    }

    .summary.valid   { background: #0e2a1a; border-left: 3px solid #27ae60; color: #2ecc71; }
    .summary.invalid { background: #2a0e0e; border-left: 3px solid #c0392b; color: #e74c3c; }
    .summary.loading { background: #111828; border-left: 3px solid #607090; color: #607090; }

    /* ── Window tables ── */
    .window-section { margin-bottom: 18px; }

    .window-label {
      font-size: 0.72rem;
      color: #556;
      margin-bottom: 5px;
      font-family: monospace;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.83rem;
      font-family: monospace;
    }

    th {
      padding: 5px 10px;
      text-align: left;
      background: #131e30;
      border-bottom: 1px solid #1e3050;
      color: #607090;
      font-weight: normal;
      font-size: 0.74rem;
    }

    td {
      padding: 4px 10px;
      border-bottom: 1px solid #131e30;
      vertical-align: middle;
    }

    tr.violation { background: #2e0e0e; }
    tr.violation td { border-bottom-color: #3a1010; }

    .digits-wrap { display: flex; gap: 3px; flex-wrap: wrap; }

    .digit-chip {
      display: inline-block;
      padding: 1px 6px;
      border-radius: 3px;
      font-size: 0.78rem;
      font-weight: 700;
      color: #111;
      min-width: 18px;
      text-align: center;
      cursor: default;
    }

    .delta-pos  { color: #27ae60; }
    .delta-neg  { color: #e74c3c; font-weight: 600; }
    .delta-zero { color: #444; }
    .idx-cell   { color: #445; }

    .window-gap {
      text-align: center;
      padding: 6px 0;
      color: #334;
      font-size: 0.8rem;
      letter-spacing: 4px;
    }

    .error-box {
      background: #2a0e0e;
      border-left: 3px solid #c0392b;
      padding: 10px 14px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.83rem;
      color: #e74c3c;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<header>Subset Sum Ordering Visualizer</header>

<div class="workspace">
  <div class="pane-editor">
    <div class="pane-label">def subset_sum_ordering(nums: list[int]) → (partition, radices)</div>
    <div class="versions-bar">
      <select id="versions-select">
        <option value="">— saved versions —</option>
      </select>
      <button class="ver-btn" id="ver-load-btn" disabled>Load</button>
      <button class="ver-btn" id="ver-save-btn">Save…</button>
      <button class="ver-btn danger" id="ver-delete-btn" disabled>Delete</button>
    </div>
    <div id="editor-mount"></div>
  </div>

  <div class="pane-output">
    <div class="controls">
      <label>Input</label>
      <input id="nums" type="text" value="1, 20, 5, 6, 2" spellcheck="false">
      <button id="run-btn" disabled>Loading…</button>
    </div>
    <div id="output-scroll">
      <div class="summary loading" id="pyodide-status">Loading Python (Pyodide)…</div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
<script>
// ── Fixed Python infrastructure (not user-editable) ───────────────────────────
const INFRA_PY = `
import json
from itertools import product

def _build_digit_map(group):
    """Map digit value d -> (sum_contribution, inclusion_bitmask), sorted by sum."""
    n = len(group)
    return sorted(
        (sum(group[i] for i in range(n) if mask >> i & 1), mask)
        for mask in range(2 ** n)
    )

def run_analysis(nums_json, user_code, window=4):
    # Execute the user's function definition into an isolated namespace
    try:
        ns = {}
        exec(user_code, ns)
        fn = ns.get('subset_sum_ordering')
        if fn is None:
            return json.dumps({"error": "subset_sum_ordering is not defined"})
    except Exception as e:
        return json.dumps({"error": f"Syntax error:\\n{e}"})

    nums = json.loads(nums_json)

    try:
        partition, radices = fn(nums)
    except Exception as e:
        return json.dumps({"error": f"Runtime error:\\n{e}"})

    # Guard against enormous search spaces
    total_subsets = 1
    for r in radices:
        total_subsets *= r
    if total_subsets > 65536:
        return json.dumps({"error": f"{total_subsets} subsets exceeds the 65536 cap (input too large)"})

    k = len(partition)
    if k == 0:
        return json.dumps({
            "partition": [], "radices": [], "total_subsets": 1,
            "violation_count": 0, "valid": True, "windows": []
        })

    digit_maps = [_build_digit_map(g) for g in partition]
    rows = []
    prev_sum = None

    # Iterate mixed-radix strings with the last group (largest elements) as MSB.
    # product over reversed radices gives (d_{k-1}, ..., d_0) in lex order.
    for i, digits_msb_first in enumerate(
        product(*(range(radices[j]) for j in range(k - 1, -1, -1)))
    ):
        digits = list(digits_msb_first[::-1])   # digits[g] <-> partition[g]
        s = sum(digit_maps[g][digits[g]][0] for g in range(k))

        subset = []
        for g in range(k):
            mask = digit_maps[g][digits[g]][1]
            for b in range(len(partition[g])):
                if mask >> b & 1:
                    subset.append(partition[g][b])

        delta     = (s - prev_sum) if prev_sum is not None else None
        violation = prev_sum is not None and s < prev_sum

        rows.append({
            "index": i, "digits": digits, "subset": subset,
            "sum": s, "delta": delta, "violation": violation,
        })
        prev_sum = s

    viol_idxs = {r["index"] for r in rows if r["violation"]}
    viol_count = len(viol_idxs)

    if not viol_idxs:
        return json.dumps({
            "partition": partition, "radices": radices,
            "total_subsets": len(rows), "violation_count": 0,
            "valid": True, "windows": []
        })

    # Expand each violation into a ±window neighbourhood, then group contiguous rows
    in_win = set()
    for vi in viol_idxs:
        for j in range(max(0, vi - window), min(len(rows), vi + window + 1)):
            in_win.add(j)

    sorted_idxs = sorted(in_win)
    windows, cur = [], []
    for idx in sorted_idxs:
        if not cur or idx == cur[-1] + 1:
            cur.append(idx)
        else:
            windows.append([rows[x] for x in cur])
            cur = [idx]
    if cur:
        windows.append([rows[x] for x in cur])

    return json.dumps({
        "partition": partition, "radices": radices,
        "total_subsets": len(rows), "violation_count": viol_count,
        "valid": False, "windows": windows
    })
`;

// ── Default user-editable function ────────────────────────────────────────────
const DEFAULT_PY = `\
def subset_sum_ordering(nums):
    if not nums:
        return [], []

    sorted_nums = sorted(nums)
    groups = []
    current_group = []
    prefix_sum = 0

    for num in sorted_nums:
        if current_group and prefix_sum < num:
            groups.append(current_group)
            current_group = []
        current_group.append(num)
        prefix_sum += num

    groups.append(current_group)
    radices = [2 ** len(g) for g in groups]
    return groups, radices
`;

// ── Group colour palette ───────────────────────────────────────────────────────
const PALETTE = ['#4e79a7','#f28e2b','#59a14f','#e15759','#76b7b2','#edc948','#b07aa1','#ff9da7'];
const groupColor = i => PALETTE[i % PALETTE.length];

// ── CodeMirror ─────────────────────────────────────────────────────────────────
const editor = CodeMirror(document.getElementById('editor-mount'), {
  value:          DEFAULT_PY,
  mode:           'python',
  theme:          'tomorrow-night-eighties',
  lineNumbers:    true,
  indentUnit:     4,
  tabSize:        4,
  indentWithTabs: false,
  autofocus:      true,
  extraKeys: {
    'Ctrl-Enter': runAnalysis,
    'Cmd-Enter':  runAnalysis,
  },
});
editor.setSize('100%', '100%');

// ── Pyodide bootstrap ──────────────────────────────────────────────────────────
let pyodide = null;

(async () => {
  const statusEl = document.getElementById('pyodide-status');
  try {
    pyodide = await loadPyodide();
    await pyodide.runPythonAsync(INFRA_PY);
    statusEl.remove();
    document.getElementById('run-btn').disabled = false;
    document.getElementById('run-btn').textContent = 'Run';
    runAnalysis();           // auto-run with default input
  } catch (e) {
    statusEl.textContent = `Failed to load Pyodide: ${e}`;
  }
})();

// ── Event wiring ───────────────────────────────────────────────────────────────
document.getElementById('run-btn').addEventListener('click', runAnalysis);
document.getElementById('nums').addEventListener('keydown', e => {
  if (e.key === 'Enter') runAnalysis();
});

// ── Run ────────────────────────────────────────────────────────────────────────
function parseNums(str) {
  return str.split(/[\s,]+/).filter(Boolean).map(Number);
}

async function runAnalysis() {
  if (!pyodide) return;

  const nums = parseNums(document.getElementById('nums').value);
  if (nums.length === 0)                          return renderError('Enter at least one number.');
  if (nums.some(n => !Number.isInteger(n) || n <= 0)) return renderError('All values must be strictly positive integers.');

  pyodide.globals.set('_nums_json',  JSON.stringify(nums));
  pyodide.globals.set('_user_code',  editor.getValue());

  let raw;
  try {
    raw = pyodide.runPython('run_analysis(_nums_json, _user_code)');
  } catch (e) {
    return renderError(String(e));
  }

  const result = JSON.parse(raw);
  if (result.error) return renderError(result.error);
  renderResult(result);
}

// ── Rendering ──────────────────────────────────────────────────────────────────
const outputScroll = document.getElementById('output-scroll');

function clearOutput() {
  outputScroll.innerHTML = '';
}

function renderError(msg) {
  clearOutput();
  const box = document.createElement('div');
  box.className = 'error-box';
  box.textContent = msg;
  outputScroll.appendChild(box);
}

function renderResult(result) {
  clearOutput();

  // Partition chips + radix labels
  if (result.partition.length > 0) {
    const row = document.createElement('div');
    row.className = 'partition-row';
    result.partition.forEach((group, i) => {
      if (i > 0) {
        const sep = document.createElement('span');
        sep.className = 'group-sep';
        sep.textContent = '·';
        row.appendChild(sep);
      }
      const block = document.createElement('div');
      block.className = 'group-block';

      const chip = document.createElement('span');
      chip.className = 'group-chip';
      chip.style.background = groupColor(i);
      chip.textContent = `[${group.join(', ')}]`;

      const lbl = document.createElement('span');
      lbl.className = 'radix-label';
      lbl.textContent = `r = ${result.radices[i]}`;

      block.appendChild(chip);
      block.appendChild(lbl);
      row.appendChild(block);
    });
    outputScroll.appendChild(row);
  }

  // Summary banner
  const summary = document.createElement('div');
  summary.className = `summary ${result.valid ? 'valid' : 'invalid'}`;
  summary.textContent = result.valid
    ? `✓  All ${result.total_subsets} subsets in non-decreasing sum order`
    : `✗  ${result.violation_count} violation${result.violation_count !== 1 ? 's' : ''} found across ${result.total_subsets} subsets`;
  outputScroll.appendChild(summary);

  // Violation windows
  result.windows.forEach((win, wi) => {
    const section = document.createElement('div');
    section.className = 'window-section';

    const lbl = document.createElement('div');
    lbl.className = 'window-label';
    const nv = win.filter(r => r.violation).length;
    lbl.textContent = `rows ${win[0].index}–${win[win.length-1].index}  ·  ${nv} violation${nv !== 1 ? 's' : ''}`;
    section.appendChild(lbl);

    section.appendChild(buildTable(win, result.partition));

    if (wi < result.windows.length - 1) {
      const gap = document.createElement('div');
      gap.className = 'window-gap';
      gap.textContent = '· · ·';
      section.appendChild(gap);
    }

    outputScroll.appendChild(section);
  });
}

function buildTable(rows, partition) {
  const table = document.createElement('table');

  // Header
  const thead = table.createTHead();
  const hrow = thead.insertRow();
  ['#', 'digits', 'subset', 'sum', 'Δ'].forEach(label => {
    const th = document.createElement('th');
    th.textContent = label;
    hrow.appendChild(th);
  });

  // Rows
  const tbody = table.createTBody();
  for (const row of rows) {
    const tr = tbody.insertRow();
    if (row.violation) tr.classList.add('violation');

    // Index
    const idxCell = tr.insertCell();
    idxCell.textContent = row.index;
    idxCell.className = 'idx-cell';

    // Digits — one chip per group, coloured by group index
    const dCell = tr.insertCell();
    const wrap = document.createElement('div');
    wrap.className = 'digits-wrap';
    row.digits.forEach((d, i) => {
      const chip = document.createElement('span');
      chip.className = 'digit-chip';
      chip.textContent = d;
      chip.style.background = groupColor(i);
      chip.title = `group ${i}: [${partition[i].join(', ')}]`;
      wrap.appendChild(chip);
    });
    dCell.appendChild(wrap);

    // Subset
    const subCell = tr.insertCell();
    subCell.textContent = row.subset.length === 0 ? '∅' : `{${row.subset.join(', ')}}`;

    // Sum
    tr.insertCell().textContent = row.sum;

    // Δ
    const dltCell = tr.insertCell();
    if (row.delta === null) {
      dltCell.textContent = '—';
    } else if (row.delta > 0) {
      dltCell.textContent = `+${row.delta}`;
      dltCell.className = 'delta-pos';
    } else if (row.delta < 0) {
      dltCell.textContent = `${row.delta}${row.violation ? ' ✗' : ''}`;
      dltCell.className = 'delta-neg';
    } else {
      dltCell.textContent = '0';
      dltCell.className = 'delta-zero';
    }
  }

  return table;
}

// ── Saved versions (localStorage) ─────────────────────────────────────────────
const STORAGE_KEY = 'sso_saved_versions';

function loadVersionsFromStorage() {
  try {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  } catch {
    return {};
  }
}

function saveVersionsToStorage(versions) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(versions));
}

function refreshVersionsSelect() {
  const versions = loadVersionsFromStorage();
  const sel = document.getElementById('versions-select');
  const current = sel.value;
  // Rebuild options
  sel.innerHTML = '<option value="">— saved versions —</option>';
  for (const name of Object.keys(versions).sort()) {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  }
  // Restore selection if it still exists
  if (current && versions[current]) sel.value = current;
  updateVersionButtons();
}

function updateVersionButtons() {
  const sel = document.getElementById('versions-select');
  const hasSelection = sel.value !== '';
  document.getElementById('ver-load-btn').disabled = !hasSelection;
  document.getElementById('ver-delete-btn').disabled = !hasSelection;
}

document.getElementById('versions-select').addEventListener('change', updateVersionButtons);

document.getElementById('ver-save-btn').addEventListener('click', () => {
  const name = prompt('Version name:');
  if (!name || !name.trim()) return;
  const trimmed = name.trim();
  const versions = loadVersionsFromStorage();
  if (versions[trimmed] && !confirm(`Overwrite version "${trimmed}"?`)) return;
  versions[trimmed] = editor.getValue();
  saveVersionsToStorage(versions);
  refreshVersionsSelect();
  // Select the newly saved version
  document.getElementById('versions-select').value = trimmed;
  updateVersionButtons();
});

document.getElementById('ver-load-btn').addEventListener('click', () => {
  const name = document.getElementById('versions-select').value;
  if (!name) return;
  const versions = loadVersionsFromStorage();
  if (versions[name] !== undefined) {
    editor.setValue(versions[name]);
    editor.focus();
  }
});

document.getElementById('ver-delete-btn').addEventListener('click', () => {
  const name = document.getElementById('versions-select').value;
  if (!name) return;
  if (!confirm(`Delete version "${name}"?`)) return;
  const versions = loadVersionsFromStorage();
  delete versions[name];
  saveVersionsToStorage(versions);
  refreshVersionsSelect();
});

// Populate the dropdown on load (editor always starts with DEFAULT_PY)
refreshVersionsSelect();
</script>
</body>
</html>
